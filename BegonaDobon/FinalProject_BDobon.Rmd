---
title: "Final Project"
author: "Begona Dobon"
date: "June 29, 2017"
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
---

Hard deadline is next Friday!

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)

source("readDataToMemory.R")
readInstacart()

library(DBI)
library(ggplot2)
library(ggthemes)
library(whisker)
library(magrittr)

src_tbls(sc)

```

* What is the average number of products in an order?

```{r}
number_products_order <-
  dbGetQuery(sc, "SELECT order_id, 
                  COUNT(1) AS n_products
                  FROM order_products__prior_tbl
                  GROUP BY order_id")

number_products_order %>%
  ggplot(aes(n_products)) + geom_histogram(binwidth = 5) 


```

An order has on average `{r round(mean(number_products_order$n_products))}`. 



Groups of products frequently bought together?

* Order of the products in the basket is dependent of reordering? 
-  (last positions products are impulsive and new, 
- first are common and reordered) Recommend a new product each 3 usual buys. 

Are the first 5 products in an order usually reordered?

Not all baskests have 5 products,
Get ratio of top5/whole distribution or a proportion
average by basket size 


```{r}
"SELECT order_id, 
SUM(reordered) AS Top5reordered
FROM order_products__prior_tbl
WHERE add_to_cart_order <= 5
GROUP BY order_id
ORDER BY Top5reordered DESC
LIMIT 5
" %>%
dbGetQuery(sc, .)


```

* Proportion of products in a basket that are reordered? 

```{r}
proportion_reordered_products <-
  dbGetQuery(sc, "SELECT order_id, 
                  SUM(reordered) AS totalReordered,
                  MAX(add_to_cart_order) AS sizeBasket,
                  SUM(reordered)/ MAX(add_to_cart_order) AS PropReordered
                  FROM order_products__prior_tbl
                  GROUP BY order_id
                  ORDER BY PropReordered DESC")

proportion_reordered_products %>%
  ggplot(aes(PropReordered)) + geom_histogram() +  scale_y_continuous(label=scales::comma)

proportion_reordered_products %>%
  ggplot(aes(sizeBasket)) + geom_histogram() +  scale_y_continuous(label=scales::comma)

ggplot(proportion_reordered_products, aes(sizeBasket)) + geom_histogram(binwidth=1) + scale_x_continuous(limit=c(0,50)) + scale_y_continuous(label=scales::comma)

mean(proportion_reordered_products$sizeBasket);median(proportion_reordered_products$sizeBasket)
```

Wanted to see how is the relationship between basket size and proportion of reordered items? Weird.

```{r}
proportion_reordered_products %>%
  ggplot(aes(sizeBasket,PropReordered)) + geom_point()

```


* Proportion of first 5 products in a basket that are reordered? 

```{r}
proportion_F5reordered_products <-
  dbGetQuery(sc, "SELECT order_id, 
                  SUM(reordered) AS totalReordered,
                  MAX(add_to_cart_order) AS sizeBasket,
                  SUM(reordered)/ MAX(add_to_cart_order) AS PropReordered
                  FROM order_products__prior_tbl
                  WHERE add_to_cart_order <= 5
                  GROUP BY order_id
                  ORDER BY PropReordered DESC")

proportion_F5reordered_products %>%
  ggplot(aes(PropReordered)) + geom_histogram() +  scale_y_continuous(label=scales::comma)


```


* Proportion of last 5 products in a basket that are reordered? 

```{r}
proportion_L5reordered_products <-
  dbGetQuery(sc, "SELECT order_id, 
                  SUM(reordered) AS totalReordered,
                  MAX(add_to_cart_order) AS sizeBasket,
                  SUM(reordered)/ MAX(add_to_cart_order) AS PropReordered
                  FROM order_products__prior_tbl
                  WHERE add_to_cart_order >= 5
                  GROUP BY order_id
                  ORDER BY PropReordered DESC")

proportion_L5reordered_products %>%
  ggplot(aes(PropReordered)) + geom_histogram() +  scale_y_continuous(label=scales::comma)


```



 








